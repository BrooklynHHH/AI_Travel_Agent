# ç®€åŒ–å¤šè½®å¯¹è¯ç³»ç»Ÿ

åŸºäºç”¨æˆ·è¾“å…¥å†å²çš„æµå¼å¤šè½®å¯¹è¯æ—…æ¸¸è§„åˆ’ç³»ç»Ÿï¼Œä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·éœ€æ±‚å®ç° `/api/stream` æ¥å£ã€‚

## ğŸ¯ ç³»ç»Ÿç‰¹ç‚¹

- **ä¸¥æ ¼æŒ‰éœ€æ±‚å®ç°**: å®Œå…¨æŒ‰ç…§ç”¨æˆ·çš„æ¥å£è§„èŒƒå®ç°
- **å¤šè½®å¯¹è¯æ”¯æŒ**: åŸºäº `user_input_history` å®ç°ä¸Šä¸‹æ–‡è®°å¿†
- **æµå¼è¾“å‡º**: å®æ—¶æµå¼å“åº”ï¼Œæ”¯æŒ Server-Sent Events (SSE)
- **ä¼šè¯ç®¡ç†**: è‡ªåŠ¨ä¼šè¯ç®¡ç†å’Œè¿‡æœŸæ¸…ç†
- **å·®å¼‚åŒ–å±•ç¤º**: æ ¹æ®æ¥å£æ•°æ®å­—æ®µç±»å‹è¿›è¡Œå†…å®¹æ ¼å¼åŒ–
- **ç®€åŒ–æ¶æ„**: æ¸…æ™°çš„æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤

## ğŸ“ é¡¹ç›®ç»“æ„

```
simple_multi_turn_system/
â”œâ”€â”€ __init__.py                 # åŒ…åˆå§‹åŒ–
â”œâ”€â”€ config.py                   # é…ç½®æ–‡ä»¶
â”œâ”€â”€ requirements.txt            # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ simple_multi_turn_api.py    # æ ¸å¿ƒAPIæœåŠ¡å™¨
â”œâ”€â”€ multi_turn_session.py       # ä¼šè¯ç®¡ç†æ¨¡å—
â”œâ”€â”€ content_formatter.py        # å†…å®¹æ ¼å¼åŒ–æ¨¡å—
â”œâ”€â”€ start_server.py            # å¯åŠ¨è„šæœ¬
â”œâ”€â”€ test_simple_api.py         # æµ‹è¯•è„šæœ¬
â”œâ”€â”€ README.md                  # è¯´æ˜æ–‡æ¡£
â””â”€â”€ utils/                     # å·¥å…·æ¨¡å—
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ logger.py              # æ—¥å¿—å·¥å…·
    â””â”€â”€ stream_handler.py      # æµå¼å¤„ç†å·¥å…·
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

ç¡®ä¿æ‚¨çš„ç¯å¢ƒä¸­æœ‰ä»¥ä¸‹ç›®å½•ç»“æ„ï¼š
```
agent_mi_V2/
â”œâ”€â”€ simple_multi_turn_system/  # æœ¬ç³»ç»Ÿ
â””â”€â”€ agent-mi/travel/           # æ™ºèƒ½ä½“æ¨¡å—
    â”œâ”€â”€ supervisor_agent.py
    â””â”€â”€ enhanced_stream_api_V1.py
```

### 2. å®‰è£…ä¾èµ–

```bash
cd simple_multi_turn_system
pip install -r requirements.txt
```

### 3. å¯åŠ¨æœåŠ¡å™¨

**æ–¹å¼ä¸€ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰**
```bash
python start_server.py
```

**æ–¹å¼äºŒï¼šç›´æ¥å¯åŠ¨**
```bash
python simple_multi_turn_api.py
```

### 4. æµ‹è¯•ç³»ç»Ÿ

```bash
python test_simple_api.py
```

## ğŸ“‹ APIæ¥å£

### æ ¸å¿ƒæ¥å£ï¼šPOST /api/stream

è¿™æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒæ¥å£ï¼Œå®Œå…¨æŒ‰ç…§ç”¨æˆ·éœ€æ±‚å®ç°ï¼š

**è¯·æ±‚æ ¼å¼ï¼š**
```bash
curl -X POST http://localhost:5000/api/stream \
  -H "Content-Type: application/json" \
  -d '{"user_input": "æ¨èé£æ™¯"}'
```

**è¯·æ±‚å‚æ•°ï¼š**
- `user_input` (å¿…éœ€): ç”¨æˆ·è¾“å…¥å†…å®¹
- `session_id` (å¯é€‰): ä¼šè¯IDï¼Œä¸æä¾›åˆ™è‡ªåŠ¨åˆ›å»º

**å“åº”æ ¼å¼ï¼š**
æµå¼ Server-Sent Events (SSE) å“åº”ï¼ŒåŒ…å«ä»¥ä¸‹ç±»å‹çš„æ•°æ®ï¼š

1. **å¼€å§‹å¤„ç†**
```json
{
  "type": "start",
  "message": "å¼€å§‹å¤„ç†è¯·æ±‚",
  "session_id": "uuid",
  "timestamp": "2025-07-11T12:00:00"
}
```

2. **æ™ºèƒ½ä½“å¼€å§‹å·¥ä½œ**
```json
{
  "type": "agent_start",
  "agent": "supervisor",
  "agent_name": "æ€»æ§æ™ºèƒ½ä½“",
  "timestamp": "2025-07-11T12:00:01"
}
```

3. **å†…å®¹æ›´æ–°**
```json
{
  "type": "content_update",
  "agent": "tour_search_agent",
  "agent_name": "æ™¯ç‚¹æœç´¢ä¸“å®¶",
  "content": "ä¸ºæ‚¨æ¨èä»¥ä¸‹é£æ™¯åèƒœ...",
  "content_type": "recommendation",
  "timestamp": "2025-07-11T12:00:02"
}
```

4. **å¤„ç†å®Œæˆ**
```json
{
  "type": "done",
  "message": "å¤„ç†å®Œæˆ",
  "final_response": "å®Œæ•´çš„å›å¤å†…å®¹",
  "agents_used": ["supervisor", "tour_search_agent"],
  "timestamp": "2025-07-11T12:00:10"
}
```

### å…¶ä»–æ¥å£

- `GET /api/health` - å¥åº·æ£€æŸ¥
- `GET /api/status` - æœåŠ¡çŠ¶æ€
- `GET /api/sessions` - åˆ—å‡ºæ‰€æœ‰ä¼šè¯
- `GET /api/sessions/<id>` - è·å–ä¼šè¯ä¿¡æ¯
- `DELETE /api/sessions/<id>` - åˆ é™¤ä¼šè¯
- `POST /api/sessions/<id>/clear` - æ¸…ç©ºä¼šè¯å†å²

## ğŸ”„ å¤šè½®å¯¹è¯é€»è¾‘

ç³»ç»Ÿä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·éœ€æ±‚å®ç°å¤šè½®å¯¹è¯ï¼š

1. **æ¥å—ç”¨æˆ·è¾“å…¥** â†’ å°†ç”¨æˆ·è¾“å…¥æ·»åŠ åˆ° `user_input_history`
2. **æ„å»ºä¸Šä¸‹æ–‡** â†’ å°† `user_input_history` ä¼ å…¥ `user_input` å‚æ•°
3. **è°ƒç”¨æ¥å£** â†’ ä½¿ç”¨æµå¼è¾“å‡ºå®ç°å®æ—¶å“åº”
4. **å·®å¼‚åŒ–å±•ç¤º** â†’ æ ¹æ®æ¥æ”¶åˆ°çš„ä¿¡æ¯ç±»å‹è¿›è¡Œä¸åŒå±•ç¤º
5. **å¾ªç¯å¤„ç†** â†’ é‡å¤ä»¥ä¸Šæ­¥éª¤å®ç°å¤šè½®å¯¹è¯

### ç¤ºä¾‹å¤šè½®å¯¹è¯

**ç¬¬1è½®ï¼š**
```bash
curl -X POST http://localhost:5000/api/stream \
  -H "Content-Type: application/json" \
  -d '{"user_input": "æ¨èé£æ™¯"}'
```

**ç¬¬2è½®ï¼ˆä½¿ç”¨ç›¸åŒsession_idï¼‰ï¼š**
```bash
curl -X POST http://localhost:5000/api/stream \
  -H "Content-Type: application/json" \
  -d '{"user_input": "æˆ‘æƒ³å»åŒ—äº¬", "session_id": "your-session-id"}'
```

ç³»ç»Ÿä¼šè‡ªåŠ¨æ„å»ºåŒ…å«å†å²çš„ä¸Šä¸‹æ–‡ï¼š
```
ç”¨æˆ·è¾“å…¥å†å²:
1. æ¨èé£æ™¯
2. æˆ‘æƒ³å»åŒ—äº¬

å½“å‰ç”¨æˆ·è¾“å…¥: æˆ‘æƒ³å»åŒ—äº¬
```

## ğŸ¨ å†…å®¹æ ¼å¼åŒ–

ç³»ç»Ÿæ ¹æ®æ¥å£æ•°æ®å­—æ®µç±»å‹è¿›è¡Œå·®å¼‚åŒ–å±•ç¤ºï¼š

- **start**: å¼€å§‹å¤„ç†æ¶ˆæ¯ ğŸš€
- **agent_start**: æ™ºèƒ½ä½“å¼€å§‹å·¥ä½œ ğŸ¤–
- **content_update**: å†…å®¹æ›´æ–° ğŸ“
- **done**: å¤„ç†å®Œæˆ âœ…
- **error**: é”™è¯¯ä¿¡æ¯ âŒ

æ¯ç§ç±»å‹éƒ½æœ‰å¯¹åº”çš„å›¾æ ‡ã€é¢œè‰²å’Œæ˜¾ç¤ºæ ·å¼ã€‚

## ğŸ“Š ä¼šè¯ç®¡ç†

- **è‡ªåŠ¨ä¼šè¯åˆ›å»º**: ä¸æä¾›session_idæ—¶è‡ªåŠ¨åˆ›å»º
- **å†å²è®°å½•ç®¡ç†**: è‡ªåŠ¨ç»´æŠ¤ç”¨æˆ·è¾“å…¥å†å²
- **è¿‡æœŸæ¸…ç†**: è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯ï¼ˆé»˜è®¤1å°æ—¶ï¼‰
- **é•¿åº¦é™åˆ¶**: å†å²è®°å½•é•¿åº¦é™åˆ¶ï¼ˆé»˜è®¤10è½®ï¼‰

## ğŸ”§ é…ç½®è¯´æ˜

ä¸»è¦é…ç½®é¡¹åœ¨ `config.py` ä¸­ï¼š

```python
# APIé…ç½®
API_HOST = '0.0.0.0'
API_PORT = 5000

# ä¼šè¯é…ç½®
MAX_HISTORY_LENGTH = 10      # æœ€å¤§å†å²é•¿åº¦
SESSION_TIMEOUT = 3600       # ä¼šè¯è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰

# æ™ºèƒ½ä½“é…ç½®
SUPERVISOR_CONFIG = {
    'verbose_level': 1,
    'show_tokens': True,
    'show_progress': True,
    'show_timing': True
}
```

## ğŸ“ æ—¥å¿—è®°å½•

ç³»ç»Ÿæä¾›è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼š

- ç”¨æˆ·è¾“å…¥è®°å½•
- ç³»ç»Ÿå“åº”è®°å½•
- æµå¼æ•°æ®å¤„ç†è®°å½•
- ä¼šè¯äº‹ä»¶è®°å½•
- é”™è¯¯ä¿¡æ¯è®°å½•

æ—¥å¿—æ–‡ä»¶ï¼š`simple_multi_turn.log`

## ğŸ§ª æµ‹è¯•

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯ç³»ç»ŸåŠŸèƒ½ï¼š

```bash
python test_simple_api.py
```

æµ‹è¯•å†…å®¹åŒ…æ‹¬ï¼š
- å¥åº·æ£€æŸ¥
- å•æ¬¡æµå¼APIè°ƒç”¨
- å¤šè½®å¯¹è¯æµ‹è¯•
- ä¼šè¯ç®¡ç†åŠŸèƒ½
- çŠ¶æ€æ¥å£æµ‹è¯•

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å¯¼å…¥æ¨¡å—å¤±è´¥**
   - ç¡®ä¿ `agent-mi/travel` ç›®å½•å­˜åœ¨
   - æ£€æŸ¥å¿…éœ€æ–‡ä»¶æ˜¯å¦å­˜åœ¨

2. **ä¾èµ–å®‰è£…å¤±è´¥**
   - ä½¿ç”¨ `pip install -r requirements.txt` å®‰è£…ä¾èµ–
   - æ£€æŸ¥Pythonç‰ˆæœ¬å…¼å®¹æ€§

3. **ç«¯å£å ç”¨**
   - ä¿®æ”¹ `config.py` ä¸­çš„ `API_PORT` é…ç½®
   - æˆ–åœæ­¢å ç”¨5000ç«¯å£çš„å…¶ä»–æœåŠ¡

4. **æµå¼å“åº”å¼‚å¸¸**
   - æ£€æŸ¥ç½‘ç»œè¿æ¥
   - ç¡®è®¤å®¢æˆ·ç«¯æ”¯æŒSSE

### è°ƒè¯•æ¨¡å¼

å¯åŠ¨æ—¶è®¾ç½®è°ƒè¯•æ¨¡å¼ï¼š
```python
DEBUG_MODE = True  # åœ¨config.pyä¸­è®¾ç½®
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨æµå¼å¤„ç†å‡å°‘å†…å­˜å ç”¨
- è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯
- å¼‚æ­¥å¤„ç†æé«˜å¹¶å‘æ€§èƒ½
- æ™ºèƒ½ç¼“å†²å‡å°‘ç½‘ç»œå¼€é”€

## ğŸ¤ æ‰©å±•å¼€å‘

ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•ï¼š

1. **æ·»åŠ æ–°çš„å†…å®¹ç±»å‹**: ä¿®æ”¹ `content_formatter.py`
2. **æ‰©å±•ä¼šè¯åŠŸèƒ½**: ä¿®æ”¹ `multi_turn_session.py`
3. **æ·»åŠ æ–°æ¥å£**: åœ¨ `simple_multi_turn_api.py` ä¸­æ·»åŠ è·¯ç”±
4. **è‡ªå®šä¹‰æµå¼å¤„ç†**: ä¿®æ”¹ `utils/stream_handler.py`

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚

## ğŸ™‹â€â™‚ï¸ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. æ—¥å¿—æ–‡ä»¶ `simple_multi_turn.log`
2. æ§åˆ¶å°è¾“å‡ºä¿¡æ¯
3. æµ‹è¯•è„šæœ¬ç»“æœ

---

**ğŸ¯ æ ¸å¿ƒç›®æ ‡**: ä¸¥æ ¼æŒ‰ç…§ç”¨æˆ·éœ€æ±‚å®ç°åŸºäº `user_input_history` çš„å¤šè½®å¯¹è¯æµå¼æ¥å£ç³»ç»Ÿã€‚
