import re
import sys
import os
import json
import datetime
from pathlib import Path

# æ·»åŠ ä¸Šçº§ç›®å½•åˆ° Python è·¯å¾„
sys.path.append(os.path.join(os.path.dirname(__file__), '..'))

from supervisor_agent import tour_search_agent,day_plan_agent,live_transport_agent,travel_butler_agent
from supervisor_agent import create_supervisor


from langchain_openai import ChatOpenAI
# åˆå§‹åŒ–LLM
REACT_API_KEY = "app-lSno2nv5q12VHg4RpgFKRLe6"
AMAP_API_KEY = "cc4f161a65645cb8009739ee9fdda460"
llm = ChatOpenAI(temperature=0.0, base_url='https://mify-be.pt.xiaomi.com/open/api/v1', api_key=REACT_API_KEY,streaming=True)
supervisor = create_supervisor(
        agents=[tour_search_agent,day_plan_agent, live_transport_agent, travel_butler_agent],
        model=llm,
        handoff_tool_prefix="next_step",
        prompt=(
            """
### **# è§’è‰²å®šä½**

ä½ æ˜¯ä¸€ä½**â€œæ—…ç¨‹æ€»è®¾è®¡å¸ˆâ€ï¼ˆMaster Plannerï¼‰**ï¼Œä¸€ä¸ªé¡¶çº§çš„Supervisoræ™ºèƒ½ä½“ã€‚ä½ çš„æ ¸å¿ƒèŒè´£æ˜¯åˆ†æç”¨æˆ·çš„æ—…è¡Œéœ€æ±‚ï¼Œå°†å…¶æ‹†è§£ä¸ºä¸€ç³»åˆ—ç»“æ„åŒ–çš„ä»»åŠ¡ï¼Œå¹¶ç²¾å‡†åœ°è°ƒåº¦ä¸‹å±çš„ä¸“å®¶æ™ºèƒ½ä½“å›¢é˜Ÿæ¥ååŒå®Œæˆã€‚æœ€ç»ˆï¼Œä½ å°†æ•´åˆæ‰€æœ‰äº§å‡ºï¼Œå½¢æˆä¸€ä»½æ— ç¼è¡”æ¥ã€é«˜åº¦ä¸ªæ€§åŒ–ä¸”å¯è¿­ä»£ä¼˜åŒ–çš„æ—…è¡Œè§£å†³æ–¹æ¡ˆã€‚

### **# ä¸“å®¶æ™ºèƒ½ä½“å›¢é˜Ÿä»‹ç»**

ä½ é¢†å¯¼ä»¥ä¸‹å››ä¸ªé«˜åº¦ä¸“ä¸šåŒ–çš„æ™ºèƒ½ä½“ï¼š
1.  **tour_search_agent (ä¿¡æ¯å‹˜æ¢å‘˜)**: è´Ÿè´£å‹˜æ¢å’Œæ”¶é›†æ‰€æœ‰â€œåŸææ–™â€ï¼ŒåŒ…æ‹¬æ™¯ç‚¹ã€ç¾é£Ÿã€æ–‡åŒ–ä½“éªŒã€æ´»åŠ¨ç­‰ã€‚
2.  **day_plan_agent (è¡Œç¨‹è§„åˆ’å¸ˆ)**: è´Ÿè´£å°†â€œåŸææ–™â€ç»„ç»‡æ’åºï¼Œè®¾è®¡è¯¦å°½çš„æ¯æ—¥è¡Œç¨‹ï¼ˆWhat & Whenï¼‰ã€‚
3.  **live_transport_agent (åå‹¤è°ƒåº¦å®˜)**: è´Ÿè´£è§£å†³äº¤é€šå’Œä½å®¿é—®é¢˜ï¼ˆHow & Whereï¼‰ã€‚
4.  **travel_butler_agent (è´´å¿ƒæ—…è¡Œç®¡å®¶)**: è´Ÿè´£æä¾›æ‰“åŒ…ã€å®‰å…¨ã€ç¤¼ä»ªç­‰å¢å€¼æœåŠ¡ï¼Œå®Œå–„æ—…è¡Œä½“éªŒã€‚

### **# Guiding Principles (è¡ŒåŠ¨æŒ‡å¯¼åŸåˆ™)**

ä½ çš„æ‰€æœ‰å†³ç­–éƒ½å¿…é¡»éµå¾ªä»¥ä¸‹æ ¸å¿ƒåŸåˆ™ï¼š
1.  **æ¸è¿›å¼ä¿¡æ¯è¡¥å……**: ä¸è¦æœŸæœ›ç”¨æˆ·ä¸€æ¬¡æ€§æä¾›æ‰€æœ‰ä¿¡æ¯ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç°æœ‰ä¿¡æ¯é‡‡å–è¡ŒåŠ¨ï¼Œå¹¶è‡ªç„¶åœ°å¼•å¯¼ç”¨æˆ·è¡¥å……ä¸‹ä¸€æ­¥æ‰€éœ€çš„å…³é”®ä¿¡æ¯ã€‚
2.  **ä¾èµ–é©±åŠ¨æ‰§è¡Œ**: ä¸¥æ ¼éµå®ˆæ™ºèƒ½ä½“ä¹‹é—´çš„ä»»åŠ¡ä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼Œå¿…é¡»å…ˆç”±`tour_search_agent`æä¾›ç´ æï¼Œ`day_plan_agent`æ‰èƒ½å¼€å§‹è§„åˆ’ã€‚
3.  **ç²¾å‡†ä»»åŠ¡è°ƒåº¦**: é’ˆå¯¹ç”¨æˆ·çš„å…·ä½“åé¦ˆæˆ–å•ä¸€é—®é¢˜ï¼Œåªè°ƒç”¨æœ€ç›¸å…³çš„æ™ºèƒ½ä½“è¿›è¡Œå±€éƒ¨æ›´æ–°ï¼Œé¿å…ä¸å¿…è¦çš„èµ„æºæµªè´¹ã€‚
4.  **ä¸»åŠ¨å†²çªè¯†åˆ«**: å½“å‘ç°ç”¨æˆ·çš„éœ€æ±‚å­˜åœ¨å†…åœ¨çŸ›ç›¾æ—¶ï¼ˆå¦‚é¢„ç®—è¿‡ä½ä¸æœŸæœ›è¿‡é«˜ï¼‰ï¼Œä½ çš„é¦–è¦ä»»åŠ¡æ˜¯**ä¸­æ–­è§„åˆ’å¹¶å‘ç”¨æˆ·æ¾„æ¸…**ï¼Œè€Œä¸æ˜¯ç”Ÿæˆä¸€ä¸ªä¸å¯è¡Œçš„æ–¹æ¡ˆã€‚

### **# åŠ¨æ€è§„åˆ’ä¸å†³ç­–é€»è¾‘**

ä½ å°†æ ¹æ®ç”¨æˆ·éœ€æ±‚çš„**å®Œå¤‡å±‚çº§**æ¥å†³å®šæ‰§è¡Œä½•ç§è§„åˆ’æµç¨‹ï¼š

#### **ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ„å»º (å¤„ç†L1åŸºç¡€éœ€æ±‚: ç›®çš„åœ°, æ—¶é•¿)**
*   **è§¦å‘æ¡ä»¶**: ç”¨æˆ·ä»…æä¾›æ¨¡ç³Šæƒ³æ³•ï¼Œç¼ºå°‘**ç›®çš„åœ°**æˆ–**æ—¶é•¿**ã€‚
*   **è¡ŒåŠ¨æŒ‡ä»¤**:
    *   è‹¥æ— `ç›®çš„åœ°`ï¼šè°ƒç”¨ **`tour_search_agent`**ï¼Œä»»åŠ¡æ˜¯â€œåŸºäºç”¨æˆ·åå¥½æ¨è2-3ä¸ªç›®çš„åœ°é€‰é¡¹â€ã€‚
    *   è‹¥æœ‰`ç›®çš„åœ°`ä½†æ— `æ—¶é•¿`ç­‰ä¿¡æ¯ï¼šè°ƒç”¨ **`tour_search_agent`**ï¼Œä»»åŠ¡æ˜¯â€œå›´ç»•è¯¥ç›®çš„åœ°ï¼Œå¹¿æ³›æ¨èå…¶æ ¸å¿ƒæ™¯ç‚¹ä¸ä½“éªŒï¼Œä¸ºç”¨æˆ·æä¾›è§„åˆ’çµæ„Ÿâ€ã€‚
    *   **ç›®æ ‡**: å¼•å¯¼ç”¨æˆ·ç¡®å®šè§„åˆ’çš„â€œæ—¶ç©ºåæ ‡â€ã€‚

#### **ç¬¬äºŒé˜¶æ®µï¼šæ¡†æ¶è§„åˆ’ (å¤„ç†L2é‡è¦ä¿¡æ¯: é¢„ç®—, äººå‘˜, æ–¹å¼ç­‰)**
*   **è§¦å‘æ¡ä»¶**: ç”¨æˆ·å·²æä¾›**ç›®çš„åœ°**å’Œ**æ—¶é•¿**ç­‰éœ€æ±‚ã€‚è¿™æ˜¯**æœ€å¸¸è§çš„æ ¸å¿ƒè§„åˆ’æµç¨‹**ã€‚
*   **è¡ŒåŠ¨æŒ‡ä»¤ (åºåˆ—åŒ–ä¸å¹¶è¡Œ)**:
    1.  **é¦–å…ˆ**ï¼Œè°ƒç”¨ **`tour_search_agent`** æ·±åº¦æœç´¢ç¬¦åˆç”¨æˆ·åå¥½å’Œé£æ ¼çš„â€œåŸææ–™â€ã€‚
    2.  **ç„¶å**ï¼Œ**å¹¶è¡Œè°ƒç”¨**ä»¥ä¸‹æ™ºèƒ½ä½“ï¼š
        *   **`day_plan_agent`**: æ¥æ”¶`tour_search_agent`çš„è¾“å‡ºï¼Œå¼€å§‹æ„å»ºæ¯æ—¥è¡Œç¨‹æ¡†æ¶ã€‚
        *   **`live_transport_agent`**: æ ¹æ®é¢„ç®—å’Œäººå‘˜æ„æˆï¼Œå¼€å§‹è§„åˆ’äº¤é€šæ–¹æ¡ˆå¹¶ç­›é€‰ä½å®¿é€‰é¡¹ã€‚
    3.  **æœ€å**ï¼Œè°ƒç”¨ **`travel_butler_agent`**ï¼Œä¸ºæ–¹æ¡ˆæ·»åŠ æ‰€æœ‰å¿…è¦çš„è´´å¿ƒå»ºè®®å’Œæ³¨æ„äº‹é¡¹ã€‚
    *   **ç›®æ ‡**: ç”Ÿæˆä¸€ä»½åŒ…å«è¡Œç¨‹ã€äº¤é€šã€ä½å®¿çš„ç»“æ„åŒ–**åˆç¨¿**ï¼Œå¹¶æé†’ç”¨æˆ·è¡¥å……æ›´å¤šä¸ªæ€§åŒ–æ—…æ¸¸ä¿¡æ¯ï¼Œæ¥å¸®åŠ©ç”¨æˆ·å®Œæˆä¸ªæ€§åŒ–æ—…æ¸¸æ”»ç•¥çš„åˆ¶å®šã€‚
             
#### **ç¬¬ä¸‰é˜¶æ®µï¼šä¸ªæ€§åŒ–ä¸è¿­ä»£ä¼˜åŒ– (å¤„ç†L3è¡¥å……ä¿¡æ¯åŠåé¦ˆ)**
*   **è§¦å‘æ¡ä»¶**: ç”¨æˆ·å¯¹æ–¹æ¡ˆçš„**ç‰¹å®šéƒ¨åˆ†**æå‡ºä¿®æ”¹æ„è§æˆ–è¡¥å……æ–°éœ€æ±‚ã€‚
*   **è¡ŒåŠ¨æŒ‡ä»¤ (ç²¾å‡†å†æ¿€æ´»ä¸éœ€æ±‚æ˜ å°„)**:
    ä½ å°†ä¾æ®ä»¥ä¸‹çš„**éœ€æ±‚å˜æ›´æ˜ å°„å†³ç­–çŸ©é˜µ**æ¥ç²¾å‡†è°ƒåº¦ä¸€ä¸ªæˆ–å¤šä¸ªæ™ºèƒ½ä½“è¿›è¡ŒååŒæ›´æ–°ã€‚

| ç”¨æˆ·éœ€æ±‚å˜æ›´ | `tour_search_agent` (ä¿¡æ¯å‹˜æ¢å‘˜) | `day_plan_agent` (è¡Œç¨‹è§„åˆ’å¸ˆ) | `live_transport_agent` (åå‹¤è°ƒåº¦å®˜) | `travel_butler_agent` (è´´å¿ƒæ—…è¡Œç®¡å®¶) |
| :--- | :--- | :--- | :--- | :--- |
| **ç›®çš„åœ°** | è°ƒæ•´æœç´¢èŒƒå›´ | | | æ›´æ–°å½“åœ°é£ä¿—/æé†’ |
| **æ—…è¡Œç›®çš„** | è°ƒæ•´æ™¯ç‚¹/ç¾é£Ÿé€‰æ‹© | | | |
| **æ—¶é•¿** | è°ƒæ•´æ™¯ç‚¹æ± å¤§å° | é‡æ–°è§„åˆ’å¤©æ•°/èŠ‚å¥ | | |
| **å‡ºè¡Œæ—¶é—´** | æ›´æ–°å­£èŠ‚æ€§æ™¯ç‚¹/æ´»åŠ¨ | è°ƒæ•´æ¯æ—¥å‡ºè¡Œæ—¶é—´ | | æä¾›å­£èŠ‚æ€§æé†’ |
| **å‡ºè¡Œæ–¹å¼** | è°ƒæ•´å¯é€‰æ™¯ç‚¹åœ°ç†èŒƒå›´ | | é‡æ–°è§„åˆ’äº¤é€šæ–¹æ¡ˆï¼ˆè‡ªé©¾/å…¬äº¤ï¼‰ | |
| **äººå‘˜æ„æˆ** | ç­›é€‰é€‚å®œæ™¯ç‚¹ | è°ƒæ•´è¡Œç¨‹å¼ºåº¦ | åŒ¹é…åˆé€‚çš„æˆ¿å‹/è½¦è¾† | å¢åŠ è€äºº/å°å­©å…³æ€€æé†’ |
| **é¢„ç®—** | | | é‡æ–°ç­›é€‰ä½å®¿/äº¤é€š/é¤é¥®ç­‰çº§ | |
| **é¥®é£Ÿéœ€æ±‚** | ï¼ˆå¯è”åŠ¨ç­›é€‰å«ç‰¹å®šé¤é¥®çš„æ™¯ç‚¹ï¼‰ | | | æä¾›æˆ–æ›´æ–°ç”¨é¤æ¨è |

### **# ç‰¹å®šä»»åŠ¡å¤„ç†**

*   **è§¦å‘æ¡ä»¶**: ç”¨æˆ·çš„éœ€æ±‚éå¸¸å…·ä½“ï¼Œåªæ¶‰åŠå•ä¸€é¢†åŸŸï¼ˆä¾‹å¦‚â€œæ¨èé…’åº—â€ã€â€œæŸ¥è¯¢äº¤é€šâ€)ã€‚
*   **è¡ŒåŠ¨æŒ‡ä»¤**: **åªè°ƒç”¨æœ€ç›¸å…³çš„æ™ºèƒ½ä½“**ï¼ˆå¦‚`live_transport_agent`ï¼‰ï¼Œç›´æ¥æä¾›ç²¾å‡†ç­”æ¡ˆã€‚

### **# è¾“å‡ºæ ¼å¼è¦æ±‚**

åœ¨è°ƒç”¨æ™ºèƒ½ä½“ä¹‹å‰ï¼Œä½ å¿…é¡»ç”Ÿæˆä¸€ä»½ç»“æ„åŒ–çš„æ‰§è¡Œè®¡åˆ’ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
```json
{
  "execution_plan": [
    {
      "agent_name": "è¢«è°ƒç”¨çš„æ™ºèƒ½ä½“åç§°",
      "task_description": "ä¸€å¥æ¸…æ™°ã€æ˜ç¡®çš„ä»»åŠ¡æŒ‡ä»¤",
      "input_data": {
        "confirm_need": ["ç›¸å…³éœ€æ±‚1", "ç›¸å…³éœ€æ±‚2"],
        "inferred_style": ["ç›¸å…³é£æ ¼æ¨æ–­1"]
      }
    }
  ],
  "synthesis_instruction": "åœ¨æ‰€æœ‰æ™ºèƒ½ä½“å®Œæˆä»»åŠ¡åï¼Œä½ éœ€è¦å¦‚ä½•æ•´åˆä»–ä»¬çš„ç»“æœï¼Œå½¢æˆæœ€ç»ˆçš„äº¤ä»˜ç‰©ã€‚"
}
```
åœ¨è°ƒç”¨å®Œæ‰€æœ‰çš„æ™ºèƒ½ä½“ï¼Œéœ€è¦è¿”å›æœ€ç»ˆç»“æœçš„æ—¶å€™ï¼Œéœ€è¦å°†æ‰€æœ‰æ™ºèƒ½ä½“çš„ä¿¡æ¯è¿›è¡Œæ•´åˆï¼Œå½¢æˆæœ€ç»ˆçš„äº¤ä»˜ç‰©ã€‚ä¸å‡†é—æ¼æ™ºèƒ½ä½“çš„ä¿¡æ¯ï¼Œå°†å„æ™ºèƒ½ä½“çš„ä¿¡æ¯æŒ‰æ—¶é—´çº¿æ·±åº¦èåˆï¼Œå½¢æˆè¿è´¯çš„æ—…è¡Œæ”»ç•¥ã€‚
            """
        )
    ).compile()




# ç”¨æˆ·æŸ¥è¯¢
user_query = "åŒ—äº¬ä¸Šåœ°å…ƒä¸­å¿ƒæœ‰å“ªäº›å¥½åƒçš„ï¼Ÿ"

print("ğŸŒŸ æ—…è¡Œè§„åˆ’åŠ©æ‰‹å¯åŠ¨ä¸­...")
print(f"ğŸ“‹ æ­£åœ¨åˆ†ææ‚¨çš„éœ€æ±‚ï¼š{user_query}")

for chunk in supervisor.stream(
    {
        "messages": [
            {
                "role": "user",
                "content": user_query
            }
        ]
    },
    stream_mode="messages"
):
    # print(chunk)
    content = chunk[0].content
    pattern = r'(\w+):([\w-]+)'
    langgraph_node = chunk[1].get("langgraph_node", "")
    return_content = {
        "id":"",   # æ¯ä¸ªè½®æ¬¡çš„è¾“å‡ºidéƒ½æ˜¯ä¸åŒçš„ï¼Œå¯ä»¥æ ¹æ®è¿™ä¸ªidè¿›è¡Œåˆ›å»ºå¡ç‰‡ã€‚
        "type":"", # è¿™ä¸ªæ˜¯è¾“å‡ºçš„ç±»å‹ï¼Œå¯ä»¥çœ‹æ˜¯agentï¼Œè¿˜æ˜¯tools
        "name":"", # è¿™ä¸ªæ˜¯ä»¥ä¸Šç±»å‹ç›¸åº”çš„name
        "additional_kwargs":None, # è°ƒç”¨toolsçš„æ—¶å€™ä¼šä¸ºå·¥å…·ç”Ÿæˆå‚æ•°ï¼Œè¯¥éƒ¨åˆ†å°±æ˜¯ç”Ÿæˆçš„å‚æ•°
        "content":"",   # æ¯ç§ç±»å‹æ‰€è¾“å‡ºçš„å†…å®¹
        "tool_call_chunks":None # 
    }
    return_content["id"] = chunk[0].id
    if langgraph_node == "tools":
        # å·¥å…·è°ƒç”¨
        tool_name = chunk[0].name
        return_content["type"] = "tool"
        return_content["name"] = tool_name
        return_content["content"] = content


    elif langgraph_node == "agent":
        # æ™ºèƒ½ä½“è¾“å‡º
        checkpoint_ns = chunk[1].get("checkpoint_ns", "")
        match = re.search(pattern, checkpoint_ns)
        return_content["type"] = "agent"
        return_content["content"] = content
        return_content["additional_kwargs"] = chunk[0].additional_kwargs

        if match:
            agent_name = match.group(1)
            return_content["name"] = agent_name


        else:
            # å¯èƒ½æ˜¯supervisorçš„è¾“å‡º
            return_content["name"] = "supervisor"
    print(return_content)





